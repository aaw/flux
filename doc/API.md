The Flux API
============

Flux's API has one route for receiving events and a few routes for querying
values and counts.

The actual events accepted and values queryable depend on the Flux schema.
In what follows, we'll assume the following sample schema:

    // User following another user
    "client:gravity:action:follow": [{
      "targets": ["[followed].followers"],
      "add": "follower"
    }]

Events
======

To register an event with Flux, call `/event/:event_name?event_params`. For 
example, executing a HTTP GET against

    http://flux.art.sy/event/client:gravity:action:follow:user?follower=user:4ff448&followed=user:50000d

will add "user:4ff448" to the set user:50000d:followers.

When you query the data generated by events, it's returned in the reverse order in which
Flux received the events. You can override this by passing a time (in seconds since 
[the epoch](http://en.wikipedia.org/wiki/Epoch_\(reference_date\))) with the `@score` parameter, like so:

    http://flux.art.sy/event/client:gravity:action:follow:user?follower=user:4ff448&followed=user:50000d&@score=1347487308

Obviously, there are no guarantees about the consistency of the server clock versus the clock
on the machine where you're sending events, but passing a time override like this is useful for
playing queued events or replaying events and having them show up in queries from Flux in 
roughly the same order as they occurred.

The event API also allows setting MQL handlers at runtime. A single handler can be specified by passing `@targets[]`, along with `@add` or `@remove`, and optionally `@maxStoredValues`. For example:

    http://flux.art.sy/event/client:gravity:action:post?user=user1&post=post1&@targets[]=[user].followers.feedItems&@add=post

Querying
========

Query the members of a set by calling `/query`, and passing the set's key in the `keys[]` parameter. For example, to query the followers of user:50000d, execute a HTTP GET against

    http://flux.art.sy/query?keys[]=user:50000d:followers

You can add a `maxResults` parameter to restrict the size of the result set. `maxResults`
defaults to 50 if it's omitted. If there are more than `maxResults` results, you'll get
an opaque cursor back in the `next` field of the results. To continue paging through
results, pass this cursor as the cursor parameter of the next call to same query. For
example,

    http://flux.art.sy/query?keys[]=user:50000d:followers&maxResults=1

might return

    { results: ['user:50000e'], next: '1234' }

You can then call

    http://flux.art.sy/query?keys[]=user:50000d:followers&maxResults=10&cursor=1234

To get the following 10 results. When there are no more results, you won't get a next
field in the result.

To query the union of multiple sets, just pass the sets' keys as separate arguments to the `keys[]` parameter. For example, to find the union of all followers of either user:50000d or user:60000e:

    http://flux.art.sy/query?keys[]=user:50000d:followers&keys[]=user:60000e:followers

Counts
======

Flux keeps track of two types of counts: an estimate of the total number of 
distinct items that have ever been added to the set and a count of the total 
number of adds that have been executed against the set.

An estimate of the number of distinct items that have ever been added to a set (or union of sets) is
available at `/distinct/`:

    http://flux.art.sy/distinct?keys[]=user:50000d:followers

A count of the total number of adds is available at `/gross/`:

    http://flux.art.sy/gross?keys[]=user:50000d:followers
